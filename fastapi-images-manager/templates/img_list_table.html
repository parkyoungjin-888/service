<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metadata Table</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        th {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
<h1>img list</h1>
<form id="searchForm">
    <input type="datetime-local" id="fromTime" name="from_time" placeholder="From">
    <input type="datetime-local" id="toTime" name="to_time" placeholder="To">
    <button type="submit">조회</button>
</form>
<table id="imageTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
    </tr>
    </thead>
    <tbody id="imageTableBody">
    </tbody>
</table>
<div id="pagination" style="margin-top: 10px; text-align: center;">
    <button id="prevPage">◀</button>
    <input type="number" id="pageNum" min="1" value="1" style="width: 50px;">
    <span id="totalPage"></span>
    <button id="nextPage">▶</button>
</div>
<script>
    function convertTimestamp(str) {
      if (!str) return '';
      return Math.floor(new Date(str).getTime() / 1000) + 9 * 60 * 60;
    }
    
    let currentPage = 1;
    let totalPage = 1;

    async function fetchAndRender() {
      const fromTime = document.getElementById('fromTime').value;
      const toTime = document.getElementById('toTime').value;
      const fromTimestamp = convertTimestamp(fromTime);
      const toTimestamp = convertTimestamp(toTime);

      let url = `/images/list?project_model_name=ProjectImage&sort=-timestamp&page_size=10&page_num=${currentPage}`;
      if (fromTimestamp !== '') url += `&query=timestamp>${fromTimestamp}`;
      if (toTimestamp !== '') url += `&query=timestamp<${toTimestamp}`;

      const response = await fetch(url);
      const res = await response.json();
      const tbody = document.getElementById('imageTableBody');
      tbody.innerHTML = '';
      (res.doc_list ?? []).forEach(doc => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${doc._id ?? ''}</td>
          <td>${doc.name ?? ''}</td>
        `;
        tbody.appendChild(row);
      });

      // 페이지 정보 갱신
      const totalCount = res.total_count ?? 0;
      totalPage = Math.max(1, Math.ceil(totalCount / 10));
      document.getElementById('pageNum').value = currentPage;
      document.getElementById('totalPage').textContent = `/ ${totalPage}`;
    }

    // 날짜 조건 변경 시 1페이지로 이동
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      currentPage = 1;
      fetchAndRender();
    });

    // 페이지 번호 직접 입력
    document.getElementById('pageNum').addEventListener('change', function() {
      let val = parseInt(this.value, 10);
      if (isNaN(val) || val < 1) val = 1;
      if (val > totalPage) val = totalPage;
      currentPage = val;
      fetchAndRender();
    });

    // 이전 페이지
    document.getElementById('prevPage').addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        fetchAndRender();
      }
    });

    // 다음 페이지
    document.getElementById('nextPage').addEventListener('click', function() {
      if (currentPage < totalPage) {
        currentPage++;
        fetchAndRender();
      }
    });

    // 최초 1회 실행
    fetchAndRender();
</script>
</body>
</html>